with opportunities_with_full_circle_lead_journeys as (
    select * from {{ ref('int_opportunities_with_campaign_members') }}
)

select
    sfdc_person_id,
    sfdc_account_id,
    sfdc_opportunity_id,
    stage_6_date as event_at,
    'opportunity reached stage 6' as event_name,
    'Opportunity' as associated_record_type,
    sfdc_opportunity_id as associated_record_id,
    object_construct(
        'campaign_name',campaign_name,
        'channel',channel,
        'super_channel',super_channel,
        'marketing_program',marketing_program,
        'campaign_sourced_by',campaign_sourced_by,
        'tactic',tactic,
        'campaign_type',campaign_type,
        'audience',audience,
        'content_title',content_title,
        'mql_marketing_segment',mql_marketing_segment,
        'campaign_member_status',campaign_member_status,
        'parent_campaign_name',parent_campaign_name,
        'parent_campaign_channel',parent_campaign_channel,
        'parent_campaign_super_channel',parent_campaign_super_channel,
        'parent_campaign_marketing_program',parent_campaign_marketing_program,
        'parent_campaign_sourced_by',parent_campaign_sourced_by,
        'parent_campaign_tactic',parent_campaign_tactic,
        'parent_campaign_type',parent_campaign_type,
        'parent_campaign_audience',parent_campaign_audience,
        'parent_campaign_content_title',parent_campaign_content_title,
        'utm_campaign',utm_campaign,
        'utm_content',utm_content,
        'utm_medium',utm_medium,
        'utm_source',utm_source,
        'utm_term',utm_term,
        'referrer_page',referrer_page,
        'response_timestamp', response_timestamp,
        'response_status',response_status,
        'management_targets_line_of_business',management_targets_line_of_business,
        'management_targets_geo',management_targets_geo,
        'management_targets_super_channel',management_targets_super_channel,
        --this should only be used to generate the management plan composite key
        'opportunity_owner_region',opportunity_owner_region,
        'inquiry_date',inquiry_date,
        'mql_date',mql_date,
        'mql_timestamp',mql_timestamp,
        'sal_date',sal_date,
        'sal_timestamp',sal_timestamp,
        'fm_date',fm_date,
        'fm_timestamp',fm_timestamp,
        'inquiry_date_15_day_offset',inquiry_date_15_day_offset,
        'mql_date_15_day_offset',mql_date_15_day_offset,
        'opportunity_created_date',created_at,
        'stage_1_date',stage_1_date,
        'stage_2_date',stage_2_date,
        'stage_3_date',stage_3_date,
        'stage_4_date',stage_4_date,
        'stage_5_date',stage_5_date,
        'stage_6_date',stage_6_date,
        'close_date',close_date
    ) as attributes

from opportunities_with_full_circle_lead_journeys where stage_6_date is not null
